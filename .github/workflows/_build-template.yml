on:
  workflow_call:
    inputs:
      APPLICATION_ARCHIVE:
        required: true
        type: string
      PLUGINS_ARCHIVE:
        required: true
        type: string
      IS_PRODUCT:
        required: true
        type: boolean
      PE_RELEASE_ARCHIVE_BASE_URL:
        required: true
        type: string
      PE_RELEASE_NOTE_BASE_URL:
        required: true
        type: string
      OS_WINDOWS:
        type: string
        default: windows-2025
      INVOKE_PLUGIN_TEMPLATE:
        required: true
        type: boolean


env:
  MINIMUM_VERSION: 0.91.0
  NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
  PLATFORMS: x86,x64
  DOTNET_VERSION: 10.0.x
  VS_TEST_CONSOLE_PATH: C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\IDE\CommonExtensions\Microsoft\TestWindow
  PLUGIN_TEMPLATE_REPOSITORY_OWNER: sk-0520
  PLUGIN_TEMPLATE_REPOSITORY_NAME: Pe.PluginTemplate


jobs:
  lint-gha:
    name: "Lint Github Actions"
    runs-on: ubuntu-latest

    steps:
      - name: <Checkout> Repository
        uses: actions/checkout@v4

      - name: <Lint> gha
        shell: pwsh
        run: ./Build/lint-gha.ps1

  lint-shell:
    name: "Lint Shell"

    runs-on: ubuntu-latest

    steps:
      - name: <Checkout> Repository
        uses: actions/checkout@v4

      - name: <Lint> shellcheck
        uses: ludeeus/action-shellcheck@master

  lint-front:
    name: Lint Front
    runs-on: ${{ inputs.OS_WINDOWS }}

    steps:
      - name: <Git> conig
        run: |
          git config --global core.autocrlf false

      - name: <Checkout> Repository
        uses: actions/checkout@v4

      - name: <Add> Node/NPM
        uses: actions/setup-node@v4
        with:
          node-version-file: ./.node-version
          cache: npm

      - name: <Install> NPM
        shell: bash
        run: npm ci --ignore-scripts

      - name: <Lint> Front
        shell: bash
        run: npm run lint

  powershell-source:
    name: PowerShell

    strategy:
      fail-fast: false
      matrix:
        OS:
          - ${{ inputs.OS_WINDOWS }}
          - ubuntu-latest

    runs-on: ${{ matrix.OS }}

    steps:
      - name: <Checkout> Repository
        uses: actions/checkout@v4

      - name: <Lint> PowerShell
        shell: pwsh
        run: Invoke-ScriptAnalyzer -Path ./ -Recurse -Settings PSScriptAnalyzerSettings.psd1 -EnableExit

      - name: <Test> PowerShell
        shell: pwsh
        run: |
          foreach($file in (Get-ChildItem -Path 'Source/PowerShell.Test' -Recurse -File -Include '*.Test.ps1')) {
            echo "> $file"
            $content = Get-Content $file | % { $_ -replace '\|\s+Should\s+(?<WORD>\w+)\b', '| Should -${WORD}' }
            $content | Out-File -Path $file -Encoding UTF8
            #Get-Content $file
          }
          Source/PowerShell.Test/UT/Test-UT.ps1

  help:
    name: Help
    runs-on: ${{ inputs.OS_WINDOWS }}
    needs:
      - lint-front

    steps:
      - name: <Checkout> Repository
        uses: actions/checkout@v4

      - name: <Add> Node/NPM
        uses: actions/setup-node@v4
        with:
          node-version-file: ./.node-version
          cache: npm

      - name: <Install> NPM
        shell: bash
        run: npm ci --ignore-scripts

      - name: <Test> Script
        shell: bash
        run: npm test

      - name: <Build> Help
        shell: bash
        run: npm run help-build

      - name: <Artifact> Help
        uses: actions/upload-artifact@v4
        with:
          name: Help
          path: Output/help
          if-no-files-found: error

  document-comment:
    name: Document Comment
    runs-on: ${{ inputs.OS_WINDOWS }}
    if: github.ref != 'refs/heads/ci-test'

    steps:
      - name: <Checkout> Repository
        uses: actions/checkout@v4

      - name: <Setup> .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: <Setup> dotnet tool
        shell: cmd
        run: install-dotnet-tool.bat

      - name: <Build> Main
        shell: pwsh
        # # Âà•„Å´ÁÑ°Ë¶ñ„Åó„Åü„ÅÑ„Çè„Åë„Åò„ÇÉ„Å™„ÅÑ„Åë„Å©„ÇΩ„Éº„Çπ„Ç∏„Çß„Éç„É¨„Éº„Çø„ÅÆ„ÇÑ„Å§„ÅÆÂØæÂøú„Åå„Çà„ÅÜ„Çè„Åã„Çâ„Çì
        # continue-on-error: true
        run: |
          .\_tools\docfx docfx.json

      - name: <Archive> Document Comment
        shell: pwsh
        run: |
          7z a doc-comment.7z _doc-comment\*

      - name: <Artifact> Document Comment
        uses: actions/upload-artifact@v4
        with:
          name: DocumentComment
          path: |
            doc-comment.7z

  plugin-template:
    name: Plugin Template
    needs:
      - help
    env:
      EXPAND_DIR: plugin-template
      PROJECT_DIR: \test-plugin
      PROJECT_NAME: Plugin.Template

    strategy:
      fail-fast: false
      matrix:
        PLATFORM:
          - x86
          - x64

    runs-on: ${{ inputs.OS_WINDOWS }}

    steps:
      - name: <Setting> Job
        shell: pwsh
        run: |
          git config --global core.autocrlf false
          git config --global user.email "${{ github.job }}@example.com"
          git config --global user.name "${{ github.job }}"

      - name: <Checkout> Repository
        uses: actions/checkout@v4

      - name: <Setup> .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: <Add> msbuild to PATH
        uses: microsoft/setup-msbuild@v2
        with:
          msbuild-architecture: ${{ matrix.PLATFORM }}

      - name: <Download> Help
        uses: actions/download-artifact@v4
        with:
          name: Help
          path: artifacts/help

      - name: <Expand> Plugin Template
        shell: pwsh
        run: Expand-Archive -Verbose -Path artifacts/help/archives/plugin-template.zip -DestinationPath ${{ env.EXPAND_DIR }}

      - name: <Create> Plugin Template [NORMAL]
        if: ${{ github.event_name != 'pull_request' }}
        shell: pwsh
        run: .\${{ env.EXPAND_DIR }}\create-project.ps1 -Verbose -InformationAction Continue -ProjectDirectory ${{ env.PROJECT_DIR }} -PluginName ${{ env.PROJECT_NAME }} -PluginId ([Guid]::Empty) -DefaultNamespace ${{ env.PROJECT_NAME }} -AppTargetBranch '${{ github.ref_name }}'

      # PR „ÅØÁèæÁä∂„Éà„É™„Ç¨„Éº„Å´„Åó„Å™„ÅÑ„Åë„Å©Â∞ÜÊù•Áî®„Å´„Ç≥„Éº„Éâ„Å†„Åë„ÅØÊÆã„Åó„Å¶„Åä„Åè
      - name: <Create> Plugin Template [PR]
        if: ${{ github.event_name == 'pull_request' }}
        env:
          AppTargetBranch: ${{ github.event.pull_request.head.ref }}
        shell: pwsh
        run: |
          .\${{ env.EXPAND_DIR }}\create-project.ps1 -Verbose -InformationAction Continue -ProjectDirectory ${{ env.PROJECT_DIR }} -PluginName ${{ env.PROJECT_NAME }} -PluginId ([Guid]::Empty) -DefaultNamespace ${{ env.PROJECT_NAME }} -AppRepositoryUrl '${{ github.event.pull_request.head.repo.clone_url }}' -AppTargetBranch "$env:AppTargetBranch" -AppRevision '${{ github.event.pull_request.head.sha }}'

      - name: <Build> Plugin Template
        shell: pwsh
        run: |
          Set-Location ${{ env.PROJECT_DIR }}
          .\FullBuild.ps1 -Verbose -InformationAction Continue -Platforms ${{ matrix.PLATFORM }}

      - name: <Test> Plugin Template
        # x86 „ÅåÂãï„Åã„Å™„ÅÑÂïèÈ°å, „ÅÇ„Å®„ÅßÂØæÂá¶
        if: matrix.PLATFORM == 'x64'
        shell: pwsh
        run: |
          Set-Location ${{ env.PROJECT_DIR }}
          .\FullTest.ps1 -Verbose -InformationAction Continue -Platforms ${{ matrix.PLATFORM }}

      - name: <Archive> Plugin Template
        # x86 „ÅåÂãï„Åã„Å™„ÅÑÂïèÈ°å, „ÅÇ„Å®„ÅßÂØæÂá¶
        if: matrix.PLATFORM == 'x64'
        shell: bash
        run: ./Build/archive-compress.sh "plugin-template.tar" "${{ env.PROJECT_DIR }}"

      - name: <Artifact> Plugin Template
        # x86 „ÅåÂãï„Åã„Å™„ÅÑÂïèÈ°å, „ÅÇ„Å®„ÅßÂØæÂá¶
        if: matrix.PLATFORM == 'x64'
        uses: actions/upload-artifact@v4
        with:
          name: template-plugin-${{ matrix.PLATFORM }}
          path: plugin-template.tar
          if-no-files-found: error

  invoke-plugin-template:
    name: Invoke Plugin Template
    if: inputs.INVOKE_PLUGIN_TEMPLATE
    needs:
      - plugin-template
      - powershell-source
      - test-main
    runs-on: ubuntu-latest

    steps:
      - name: <Setting> Job
        shell: bash
        env:
          WORKFLOW_TOKEN: ${{ secrets.PE_2_PLUGINTEMPLATE_WORKFLOW_TOKEN }}
        run: |
          curl \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ env.WORKFLOW_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ env.PLUGIN_TEMPLATE_REPOSITORY_OWNER }}/${{ env.PLUGIN_TEMPLATE_REPOSITORY_NAME }}/dispatches \
            -d '{ "event_type": "invoke-plugin-template", "client_payload": { "PE_REVISION": "${{ github.sha }}", "PE_BRANCH": "${{ github.ref_name }}" }}'

  history:
    name: Release Note
    runs-on: ${{ inputs.OS_WINDOWS }}
    needs:
      - lint-front

    steps:
      - name: <Checkout> Repository
        uses: actions/checkout@v4

      - name: <Add> Node/NPM
        uses: actions/setup-node@v4
        with:
          node-version-file: ./.node-version
          cache: npm

      - name: <Install> NPM
        shell: bash
        run: npm ci --ignore-scripts

      - name: <Check> Release Note
        shell: bash
        if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop'
        run: npm run check-release-note

      - name: <Generate> Release Note
        shell: pwsh
        run: npm run generate-release-note

      - name: <Artifact> Release Note
        uses: actions/upload-artifact@v4
        with:
          name: History
          path: history/*.html
          if-no-files-found: error

  build-tools:
    name: Build BuildTools
    runs-on: ${{ inputs.OS_WINDOWS }}

    steps:
      - name: <Checkout> Repository
        uses: actions/checkout@v4

      - name: <Setup> .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: <Add> msbuild to PATH
        uses: microsoft/setup-msbuild@v2
        with:
          msbuild-architecture: x64

      - name: <Cache> Nuget
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/.nuget/packages
          key: nuget-${{ github.job }}-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            nuget-${{ github.job }}-${{ runner.os }}-${{ hashFiles('**/*.csproj') }}

      - name: <Build> BuildTools
        shell: pwsh
        run: .\Build\make-buildtools.ps1 -InformationAction Continue

      - name: <Artifact> BuildTools
        uses: actions/upload-artifact@v4
        with:
          name: BuildTools
          path: Output\tools
          if-no-files-found: error

  lint-sql:
    name: "Lint SQL"
    runs-on: ubuntu-latest

    steps:
      - name: <Checkout> Repository
        uses: actions/checkout@v4

      - name: <Lint> SQL
        shell: pwsh
        run: .\Build\lint-sql.ps1 -InformationAction Continue -RunCi

  build-tools-sql:
    name: "BuildTools SQL"
    needs:
      - build-tools
      - lint-sql
    runs-on: ${{ inputs.OS_WINDOWS }}

    steps:
      - name: <Checkout> Repository
        uses: actions/checkout@v4

      - name: <Setup> .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: <Download> BuildTools
        uses: actions/download-artifact@v4
        with:
          name: BuildTools
          path: artifacts/buildtools

      - name: <Pack> SQL
        shell: pwsh
        run: .\Build\buildtools-sql.ps1 -InformationAction Continue -BuildToolsSqlPack "artifacts\buildtools\SqlPack.exe" -OutputFile sql.sqlite3

      - name: <Artifact> SQL
        uses: actions/upload-artifact@v4
        with:
          name: SQL
          path: sql.sqlite3
          if-no-files-found: error


  build-boot:
    name: Build Boot
    env:
      MODULE: boot
    runs-on: ${{ inputs.OS_WINDOWS }}

    strategy:
      fail-fast: false
      matrix:
        PLATFORM:
          - x86
          - x64

    steps:
      - name: <Checkout> Repository
        uses: actions/checkout@v4

      - name: <Add> msbuild to PATH
        uses: microsoft/setup-msbuild@v2
        with:
          msbuild-architecture: ${{ matrix.PLATFORM }}

      - name: <Rewrite> Module
        shell: pwsh
        run: |
          $productMode = [System.Convert]::ToBoolean('${{ inputs.IS_PRODUCT }}')
          $buildType = $productMode ? '': 'BETA'
          .\Build\rewrite-module.ps1 -InformationAction Continue -Module ${{ env.MODULE }} -ProductMode -BuildType $buildType -Revision ${{ github.sha }}

      - name: <Build> Module
        shell: pwsh
        run: |
          $productMode = [System.Convert]::ToBoolean('${{ inputs.IS_PRODUCT }}')
          $buildType = $productMode ? '': 'BETA'
          .\Build\build-module.ps1 -InformationAction Continue -Module ${{ env.MODULE }} -ProductMode -BuildType $buildType -Platform ${{ matrix.PLATFORM }}

      - name: <Artifact> Module
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.MODULE }}-${{ matrix.PLATFORM }}
          path: Output\Release\${{ matrix.PLATFORM }}\Pe\*
          if-no-files-found: error

  test-boot:
    name: Test Boot
    env:
      MODULE: boot
    runs-on: ${{ inputs.OS_WINDOWS }}

    strategy:
      fail-fast: false
      matrix:
        PLATFORM:
          - x86
          - x64
        CONFIGURATION:
          - Release
          - CI_TEST

    steps:
      - name: <Checkout> Repository
        uses: actions/checkout@v4

      - name: <Add> msbuild to PATH
        uses: microsoft/setup-msbuild@v2
        with:
          msbuild-architecture: ${{ matrix.PLATFORM }}

      - name: <Setup> dotnet tool
        shell: cmd
        run: install-dotnet-tool.bat

      - name: <Setup> add OpenCppCoverage + VSTest.Console to PATH
        id: setup_opencppcoverage
        shell: pwsh
        run: |
          choco install OpenCppCoverage -y
          echo "C:\Program Files\OpenCppCoverage" >> $env:GITHUB_PATH
          echo "${{ env.VS_TEST_CONSOLE_PATH }}" >> $env:GITHUB_PATH

      - name: <Rewrite> Module
        shell: pwsh
        run: |
          $buildType = $productMode ? '': 'BETA'
          .\Build\rewrite-module.ps1 -InformationAction Continue -Module ${{ env.MODULE }} -ProductMode -BuildType $buildType -Revision ${{ github.sha }}

      - name: <Setup> Module
        shell: pwsh
        run: .\Build\setup-test-module.ps1 -InformationAction Continue -Service github -Module ${{ env.MODULE }}

      - name: <Build> Module
        shell: pwsh
        run: |
          $productMode = [System.Convert]::ToBoolean('${{ inputs.IS_PRODUCT }}')
          $buildType = $productMode ? '': 'BETA'
          $isTest = $false
          if( '${{ matrix.CONFIGURATION }}' -eq 'CI_TEST') {
            $isTest = $true
          }
          .\Build\build-module.ps1 -InformationAction Continue -Module ${{ env.MODULE }} -ProductMode -BuildType $buildType -Platform ${{ matrix.PLATFORM }} -Test:$isTest

      - name: <Test> Module
        shell: pwsh
        run: .\Build\test-module.ps1 -InformationAction Continue -Module ${{ env.MODULE }} -Platform ${{ matrix.PLATFORM }} -Configuration ${{ matrix.CONFIGURATION }}

      - name: <Make> CodeCoverage
        if: matrix.CONFIGURATION == 'CI_TEST'
        shell: pwsh
        run: |
          $files = @(Get-ChildItem -Filter coverage.cobertura.xml -Recurse)
          # # „ÇΩ„Éº„Çπ„Éï„Ç°„Ç§„É´„ÅÆ‰ΩçÁΩÆ„ÇíÊ∏°„Åó„Å¶„Åä„Åã„Å™„ÅÑ„Å®„ÇΩ„Éº„Çπ„ÅåË™≠„ÇÅ„Å™„ÅÑÂïèÈ°åÂØæÂøú(Pe.Bridge/Pe.CommonTest„Åå„ÅØ„Åó„ÇÉ„ÅÑ„Åß„Çã„ÅÆ„ÅßË£úÊ≠£)
          # $sources = @(
          #   Join-Path -Path (Get-Location) -ChildPath Source | Join-Path -ChildPath Pe
          #   Join-Path -Path (Get-Location) -ChildPath Source | Join-Path -ChildPath Pe | Join-Path -ChildPath Pe.Bridge
          #   Join-Path -Path (Get-Location) -ChildPath Source | Join-Path -ChildPath Pe | Join-Path -ChildPath Pe.CommonTest
          # )
          & .\_tools\reportgenerator `
            -reports:$($files -join ';') `
            -targetdir:"coveragereport" `
            -reporttypes:Html

      - name: <Artifact> CodeCoverage
        if: matrix.CONFIGURATION == 'CI_TEST'
        uses: actions/upload-artifact@v4
        with:
          name: Test_Pe.Boot_${{ matrix.PLATFORM }}
          path: |
            Source/Pe.Boot/*.Test/**/coverage.cobertura.xml
            coveragereport
          if-no-files-found: error

  build-main:
    name: Build Main
    env:
      MODULE: main
    runs-on: ${{ inputs.OS_WINDOWS }}

    strategy:
      fail-fast: false
      matrix:
        PLATFORM:
          - x86
          - x64

    steps:
      - name: <Checkout> Repository
        uses: actions/checkout@v4

      - name: <Setup> .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: <Add> msbuild to PATH
        uses: microsoft/setup-msbuild@v2
        with:
          msbuild-architecture: ${{ matrix.PLATFORM }}

      - name: <Cache> Nuget
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/.nuget/packages
          key: nuget-${{ github.job }}-${{ runner.os }}-${{ matrix.PLATFORM }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            nuget-${{ github.job }}-${{ runner.os }}-${{ matrix.PLATFORM }}-${{ hashFiles('**/*.csproj') }}

      - name: <Rewrite> Module
        shell: pwsh
        run: |
          $productMode = [System.Convert]::ToBoolean('${{ inputs.IS_PRODUCT }}')
          $buildType = $productMode ? '': 'BETA'
          .\Build\rewrite-module.ps1 -InformationAction Continue -Module ${{ env.MODULE }} -ProductMode -BuildType $buildType -Revision ${{ github.sha }}

      - name: <Build> Module
        shell: pwsh
        run: |
          $productMode = [System.Convert]::ToBoolean('${{ inputs.IS_PRODUCT }}')
          $buildType = $productMode ? '': 'BETA'
          .\Build\build-module.ps1 -InformationAction Continue -Module ${{ env.MODULE }} -ProductMode -BuildType $buildType -Platform ${{ matrix.PLATFORM }}

      - name: <Archive> Application
        shell: bash
        run: ./Build/archive-compress.sh "bin.tar" "Output/Release/${{ matrix.PLATFORM }}/Pe/bin"

      - name: <Artifact> Module
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.MODULE }}-bin-${{ matrix.PLATFORM }}
          path: bin.tar
          if-no-files-found: error

  test-main:
    name: Test Main
    env:
      MODULE: main
    runs-on: ${{ inputs.OS_WINDOWS }}

    strategy:
      fail-fast: false
      matrix:
        PLATFORM:
          - x86
          - x64

    steps:
      - name: <Checkout> Repository
        uses: actions/checkout@v4

      - name: <Setup> .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: <Add> msbuild to PATH
        uses: microsoft/setup-msbuild@v2
        with:
          msbuild-architecture: ${{ matrix.PLATFORM }}

      - name: <Setup> dotnet tool
        shell: cmd
        run: install-dotnet-tool.bat

      - name: <Cache> Nuget
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/.nuget/packages
          key: nuget-${{ github.job }}-${{ runner.os }}-${{ matrix.PLATFORM }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            nuget-${{ github.job }}-${{ runner.os }}-${{ matrix.PLATFORM }}-${{ hashFiles('**/*.csproj') }}

      - name: <Rewrite> Module
        shell: pwsh
        run: .\Build\rewrite-module.ps1 -InformationAction Continue -Module ${{ env.MODULE }} -ProductMode -BuildType BETA -Revision ${{ github.sha }}

      - name: <Setup> Module
        shell: pwsh
        run: .\Build\setup-test-module.ps1 -InformationAction Continue -Service github -Module ${{ env.MODULE }}

      - name: <Test> Module
        if: matrix.PLATFORM == 'x64'
        shell: pwsh
        run: .\Build\test-module.ps1 -InformationAction Continue -Module ${{ env.MODULE }} -ProductMode -BuildType BETA -Platform ${{ matrix.PLATFORM }} -Configuration Release -Logger GitHubActions

      - name: <Make> CodeCoverage
        # x86 „ÅåÂãï„Åã„Å™„ÅÑÂïèÈ°å, „ÅÇ„Å®„ÅßÂØæÂá¶
        if: matrix.PLATFORM == 'x64'
        shell: pwsh
        run: |
          $files = @(Get-ChildItem -Filter coverage.cobertura.xml -Recurse)
          # „ÇΩ„Éº„Çπ„Éï„Ç°„Ç§„É´„ÅÆ‰ΩçÁΩÆ„ÇíÊ∏°„Åó„Å¶„Åä„Åã„Å™„ÅÑ„Å®„ÇΩ„Éº„Çπ„ÅåË™≠„ÇÅ„Å™„ÅÑÂïèÈ°åÂØæÂøú(Pe.Bridge/Pe.CommonTest„Åå„ÅØ„Åó„ÇÉ„ÅÑ„Åß„Çã„ÅÆ„ÅßË£úÊ≠£)
          $sources = @(
            Join-Path -Path (Get-Location) -ChildPath Source | Join-Path -ChildPath Pe
            Join-Path -Path (Get-Location) -ChildPath Source | Join-Path -ChildPath Pe | Join-Path -ChildPath Pe.Bridge
            Join-Path -Path (Get-Location) -ChildPath Source | Join-Path -ChildPath Pe | Join-Path -ChildPath Pe.CommonTest
          )
          & .\_tools\reportgenerator `
            -reports:$($files -join ';') `
            -sourcedirs:$($sources -join ';') `
            -targetdir:"coveragereport" `
            -reporttypes:Html
          Get-Location

      - name: <Artifact> CodeCoverage
        # x86 „ÅåÂãï„Åã„Å™„ÅÑÂïèÈ°å, „ÅÇ„Å®„ÅßÂØæÂá¶
        if: matrix.PLATFORM == 'x64'
        uses: actions/upload-artifact@v4
        with:
          name: Test_Pe.Main_${{ matrix.PLATFORM }}
          path: |
            Source/Pe/*.Test/TestResults/**/coverage.cobertura.xml
            coveragereport
          if-no-files-found: error

  reconstitution-application:
    name: Reconstitution Application
    needs:
      - help
      - build-tools-sql
      - build-boot
      - build-main
    runs-on: ${{ inputs.OS_WINDOWS }}

    strategy:
      fail-fast: false
      matrix:
        PLATFORM:
          - x86
          - x64

    steps:
      - name: <Checkout> Repository
        uses: actions/checkout@v4

      # - name: <Setup> .NET ${{ env.DOTNET_VERSION }}
      #   uses: actions/setup-dotnet@v5
      #   with:
      #     dotnet-version: ${{ env.DOTNET_VERSION }}
      #
      # - name: <Download> BuildTools
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: BuildTools
      #     path: artifacts/buildtools

      - name: <Download> SQL
        uses: actions/download-artifact@v4
        with:
          name: SQL
          path: artifacts/sql

      - name: <Download> Help
        uses: actions/download-artifact@v4
        with:
          name: Help
          path: artifacts/help

      - name: <Download> Boot
        uses: actions/download-artifact@v4
        with:
          name: boot-${{ matrix.PLATFORM }}
          path: artifacts/boot

      - name: <Download> Main
        uses: actions/download-artifact@v4
        with:
          name: main-bin-${{ matrix.PLATFORM }}
          path: main-bin.tar

      - name: <Expand> Main
        shell: bash
        run: ./Build/archive-expand.sh "artifacts/main-bin" "main-bin.tar/bin.tar"

      - name: <Reconstitution> Application
        shell: pwsh
        run: |
          $productMode = [System.Convert]::ToBoolean('${{ inputs.IS_PRODUCT }}')
          $buildType = $productMode ? '': 'BETA'
          ./Build/reconstitute-application.ps1 -InformationAction Continue -Archive 7z -Platform ${{ matrix.PLATFORM }} -ProductMode:$productMode -BuildType $buildType -InputDirectory artifacts  -OutputDirectory Output

      - name: <Cleanup> Application
        shell: pwsh
        run: |
          $productMode = [System.Convert]::ToBoolean('${{ inputs.IS_PRODUCT }}')
          .\Build\cleanup-module.ps1 -InformationAction Continue -AssemblyDirectory 'Output' -ProductMode:$productMode

      - name: <Compress> Application
        shell: pwsh
        env:
          Archive: ${{ inputs.APPLICATION_ARCHIVE }}
        run: .\Build\compress-module.ps1 -InformationAction Continue -TargetDirectory 'Output' -OutputFileBaseName "Pe_${{ matrix.PLATFORM }}" -Archive "$env:Archive"

      - name: <Artifact> Application
        uses: actions/upload-artifact@v4
        with:
          name: Pe_${{ matrix.PLATFORM }}
          path: Pe_${{ matrix.PLATFORM }}.${{ inputs.APPLICATION_ARCHIVE }}
          if-no-files-found: error

  information-application:
    name: Information Application
    needs:
      - reconstitution-application
    runs-on: ubuntu-latest

    steps:
      - name: <Checkout> Repository
        uses: actions/checkout@v4

      - name: <Download> Application x86
        uses: actions/download-artifact@v4
        with:
          name: Pe_x86
          path: artifacts/Pe

      - name: <Download> Application x64
        uses: actions/download-artifact@v4
        with:
          name: Pe_x64
          path: artifacts/Pe

      - name: <üå≥> üå≤
        shell: pwsh
        run:  Get-ChildItem artifacts -R | Select-Object FullName

      - name: <Generate> Update Information
        shell: pwsh
        env:
          ArchiveBaseUrl: ${{ inputs.PE_RELEASE_ARCHIVE_BASE_URL }}
          NoteBaseUrl: ${{ inputs.PE_RELEASE_NOTE_BASE_URL }}
          Archive: ${{ inputs.APPLICATION_ARCHIVE }}
        run: .\Build\generate-update-information.ps1 -InformationAction Continue -Revision '${{ github.sha }}' -MinimumVersion ${{ env.MINIMUM_VERSION }} -ArchiveBaseUrl $env:ArchiveBaseUrl -NoteBaseUrl $env:NoteBaseUrl -OutputDirectory Output -Module 'application' -Archive $env:Archive -ArtifactDirectory (Join-Path -Path 'artifacts' -ChildPath 'Pe') -Platforms ${{ env.PLATFORMS }}

      - name: <Artifact> Update Information
        uses: actions/upload-artifact@v4
        with:
          name: Information_Pe
          path: |
            Output/update.json
            Output/*.html
            if-no-files-found: error


  build-plugins:
    name: Build Plugins
    env:
      MODULE: plugins
    runs-on: ${{ inputs.OS_WINDOWS }}

    strategy:
      fail-fast: false
      matrix:
        PLATFORM:
          - x86
          - x64

    steps:
      - name: <Checkout> Repository
        uses: actions/checkout@v4

      - name: <Setup> .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: <Add> msbuild to PATH
        uses: microsoft/setup-msbuild@v2
        with:
          msbuild-architecture: ${{ matrix.PLATFORM }}

      - name: <Cache> Nuget
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/.nuget/packages
          key: nuget-${{ github.job }}-${{ runner.os }}-${{ matrix.PLATFORM }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            nuget-${{ github.job }}-${{ runner.os }}-${{ matrix.PLATFORM }}-${{ hashFiles('**/*.csproj') }}

      - name: <Rewrite> Module
        shell: pwsh
        run: |
          $productMode = [System.Convert]::ToBoolean('${{ inputs.IS_PRODUCT }}')
          $buildType = $productMode ? '': 'BETA'
          .\Build\rewrite-module.ps1 -InformationAction Continue -Module ${{ env.MODULE }} -ProductMode -BuildType $buildType -Revision ${{ github.sha }}

      - name: <Build> Module
        shell: pwsh
        run: |
          $productMode = [System.Convert]::ToBoolean('${{ inputs.IS_PRODUCT }}')
          $buildType = $productMode ? '': 'BETA'
          .\Build\build-module.ps1 -InformationAction Continue -Module ${{ env.MODULE }} -ProductMode -BuildType $buildType -Platform ${{ matrix.PLATFORM }}
          ls Output\Release\${{ matrix.PLATFORM }}\Plugins

      - name: <Artifact> Module
        uses: actions/upload-artifact@v4
        with:
          name: plugins-${{ matrix.PLATFORM }}
          path: Output\Release\${{ matrix.PLATFORM }}\Plugins
          if-no-files-found: error

  test-plugins:
    name: Test Plugins
    env:
      MODULE: plugins
    runs-on: ${{ inputs.OS_WINDOWS }}

    strategy:
      fail-fast: false
      matrix:
        PLATFORM:
          - x86
          - x64

    steps:
      - name: <Checkout> Repository
        uses: actions/checkout@v4

      - name: <Setup> .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: <Add> msbuild to PATH
        uses: microsoft/setup-msbuild@v2
        with:
          msbuild-architecture: ${{ matrix.PLATFORM }}

      - name: <Cache> Nuget
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/.nuget/packages
          key: nuget-${{ github.job }}-${{ runner.os }}-${{ matrix.PLATFORM }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            nuget-${{ github.job }}-${{ runner.os }}-${{ matrix.PLATFORM }}-${{ hashFiles('**/*.csproj') }}

      - name: <Rewrite> Module
        shell: pwsh
        run: .\Build\rewrite-module.ps1 -InformationAction Continue -Module ${{ env.MODULE }} -ProductMode -BuildType BETA -Revision ${{ github.sha }}

      - name: <Setup> Module
        shell: pwsh
        run: .\Build\setup-test-module.ps1 -InformationAction Continue -Service github -Module ${{ env.MODULE }}

      - name: <Test> Module
        # x86 „ÅåÂãï„Åã„Å™„ÅÑÂïèÈ°å, „ÅÇ„Å®„ÅßÂØæÂá¶
        if: matrix.PLATFORM == 'x64'
        shell: pwsh
        run: .\Build\test-module.ps1 -InformationAction Continue -Module ${{ env.MODULE }} -ProductMode -BuildType BETA -Platform ${{ matrix.PLATFORM }} -Configuration Release -Logger GitHubActions

      # - name: <Artifact> result
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: Test_Pe.Plugins.Reference_${{ matrix.PLATFORM }}
      #     path: Source/**/coverage.cobertura.xml
      #     if-no-files-found: error

  reconstitution-plugins:
    name: Reconstitution Plugins
    needs:
      - build-plugins
    runs-on: ${{ inputs.OS_WINDOWS }}

    strategy:
      fail-fast: false
      matrix:
        PLATFORM:
          - x86
          - x64

    steps:
      - name: <Checkout> Repository
        uses: actions/checkout@v4

      - name: <Download> Plugins
        uses: actions/download-artifact@v4
        with:
          name: plugins-${{ matrix.PLATFORM }}
          path: artifacts/plugins

      - name: <Cleanup> Plugins
        shell: pwsh
        run: |
          $productMode = [System.Convert]::ToBoolean('${{ inputs.IS_PRODUCT }}')
          $dirs = Get-ChildItem -Path (Join-Path -Path 'artifacts' -ChildPath 'plugins')
          foreach($dir in $dirs) {
            .\Build\cleanup-module.ps1 -InformationAction Continue -AssemblyDirectory $dir.FullName -ProductMode:$productMode
          }

      - name: <Compress> Plugins
        shell: pwsh
        env:
          Archive: ${{ inputs.PLUGINS_ARCHIVE }}
        run: |
          $dirs = Get-ChildItem -Path (Join-Path -Path 'artifacts' -ChildPath 'plugins')
          foreach($dir in $dirs) {
            .\Build\compress-module.ps1 -InformationAction Continue -TargetDirectory $dir.FullName -OutputFileBaseName "$($dir.Name)_${{ matrix.PLATFORM }}" -Archive "$env:Archive"
          }

      - name: <Artifact> Plugins
        uses: actions/upload-artifact@v4
        with:
          name: Pe.Plugins.Reference_${{ matrix.PLATFORM }}
          path: ./*.${{ inputs.PLUGINS_ARCHIVE }}
          if-no-files-found: error

  information-plugins:
    name: Information Plugins
    runs-on: ubuntu-latest
    needs:
      - reconstitution-plugins

    steps:
      - name: <Checkout> Repository
        uses: actions/checkout@v4

      - name: <Download> Plugins x86
        uses: actions/download-artifact@v4
        with:
          name: Pe.Plugins.Reference_x86
          path: artifacts/Pe.Plugins.Reference

      - name: <Download> Plugins x64
        uses: actions/download-artifact@v4
        with:
          name: Pe.Plugins.Reference_x64
          path: artifacts/Pe.Plugins.Reference

      - name: <üå≥> üå≤
        shell: pwsh
        run:  Get-ChildItem artifacts -R | Select-Object Name

      - name: <Generate> Update Information
        shell: pwsh
        env:
          ArchiveBaseUrl: ${{ inputs.PE_RELEASE_ARCHIVE_BASE_URL }}
          PeReleaseNoteBaseUrl: ${{ inputs.PE_RELEASE_NOTE_BASE_URL }}
          Archive: ${{ inputs.PLUGINS_ARCHIVE }}
        run: |
          $pluginNoteBaseUrl = "$env:PeReleaseNoteBaseUrl".Replace("github.com", "pe.invalid")
          .\Build\generate-update-information.ps1 -InformationAction Continue -Revision '${{ github.sha }}' -MinimumVersion ${{ env.MINIMUM_VERSION }} -ArchiveBaseUrl $env:ArchiveBaseUrl -NoteBaseUrl $pluginNoteBaseUrl -OutputDirectory Output -Module 'plugins' -Archive $env:Archive -ArtifactDirectory (Join-Path -Path 'artifacts' -ChildPath 'Pe.Plugins.Reference') -Platforms ${{ env.PLATFORMS }}

      - name: <üå≥> üå≤
        shell: pwsh
        run:  Get-ChildItem artifacts -R | Select-Object Name

      - name: <Artifact> Update Information
        uses: actions/upload-artifact@v4
        with:
          name: Information_Pe.Plugins.Reference
          path: |
            Output/update-*.json
            Output/*.html
          if-no-files-found: error


  check-dotnet-app-library:
    name: Check Pe.Library.*
    runs-on: ubuntu-latest

    steps:
      - name: <Checkout> Repository
        uses: actions/checkout@v4

      - name: <Check> Pe.Library + workflow
        shell: pwsh
        run: Build/app-library-workflow.ps1

  test-dotnet-app-library:
    name: Test Pe.Library.*
    needs:
      - check-dotnet-app-library

    strategy:
      fail-fast: false
      matrix:
        OS:
          - windows-2025
          - windows-2022
          - ubuntu-24.04
          - ubuntu-22.04
        TARGET:
          - Pe.Library.Provider.Test
          - Pe.Library.Args.Test
          - Pe.Library.Property.Test
          - Pe.Library.Common.Test
          - Pe.Library.Database.Test
          - Pe.Library.Database.Sqlite.Test
          - Pe.Library.DependencyInjection.Test

    runs-on: ${{ matrix.OS }}

    steps:
      - name: <Checkout> Repository
        uses: actions/checkout@v4

      - name: <Setup> .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: <Cache> Nuget
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/.nuget/packages
          key: nuget-${{ github.job }}-${{ runner.os }}-${{ matrix.TARGET }}-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            nuget-${{ github.job }}-${{ runner.os }}-${{ matrix.TARGET }}-${{ hashFiles('**/*.csproj') }}

      # - name: <Test> Add Logger ${{ matrix.TARGET }}
      #   shell: bash
      #   run: |
      #     cd Source/Pe/${{ matrix.TARGET }}
      #     nuget install GitHubActionsTestLogger

      - name: <Test> Run ${{ matrix.TARGET }}
        shell: bash
        run: |
          cd Source/Pe/${{ matrix.TARGET }}
          dotnet test


  st-powershell:
    name: System Test PowerShell
    env:
      UPDATE_DESTINATION: \dest
    runs-on: ${{ inputs.OS_WINDOWS }}
    needs:
      - powershell-source

    steps:
      - name: <Checkout> Repository
        uses: actions/checkout@v4

      - name: <Test> Update
        shell: pwsh
        run: .\Source\PowerShell.Test\ST\update-application.test.ps1 -Source (Get-Location).Path -Destination ${{ env.UPDATE_DESTINATION }} -Command ([Environment]::ExpandEnvironmentVariables('%SystemRoot%\System32\winver.exe'))

      - name: <Artifact> Update:Error
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.job }}-Update.log
          path: ${{ env.UPDATE_DESTINATION }}.log
          if-no-files-found: error

  build-icon:
    name: Icon
    runs-on: ubuntu-latest
    needs:
      - lint-gha
      - lint-shell
      - powershell-source

    strategy:
      matrix:
        TYPE:
          - release
          - debug
          - beta
          - plugin

    steps:
      - name: <Checkout> Repository
        uses: actions/checkout@v4

      - name: Delete *.ico
        shell: bash
        # „É™„Éù„Ç∏„Éà„É™ÂÜÖ„Å´Ê≠£„Å®„Åô„Çã ico „Åå„ÅÇ„Çã„ÅÆ„ÅßÊ∑∑‰π±„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´ÂâäÈô§
        run: rm Resource/Icon/*.ico

      - name: Retouch
        shell: bash
        run: |
          cd Resource
          docker compose run retouch pwsh work/EntryRetouch.ps1 -mode ${{ matrix.TYPE }}

      - name: SVG -> PNG
        shell: bash
        run: |
          cd Resource
          docker compose run drawing /bin/bash -ue /work/export-png.sh --svg /data/@data/${{ matrix.TYPE }}/App.svg --output /data/@data/${{ matrix.TYPE }}

      - name: PNG -> ICO
        shell: bash
        run: |
          cd Resource
          docker compose run --entrypoint "python /work/create-ico.py --dir /data/@data/${{ matrix.TYPE }} --output /data/@data/${{ matrix.TYPE }}/App.ico" python

      - name: <Artifact> Icon
        uses: actions/upload-artifact@v4
        with:
          name: Icon-${{ matrix.TYPE }}
          path: Resource/Icon
          if-no-files-found: error

  package-icon:
    name: Package Icons
    runs-on: ubuntu-latest
    needs:
      - build-icon

    steps:
      - name: <Checkout> Repository
        uses: actions/checkout@v4

      - name: Download Icon Artifacts
        uses: actions/download-artifact@v4
        with:
          path: icons

      - name: Collect and Rename Icons
        shell: pwsh
        run: ./Build/package-icon.ps1 -ArtifactDirectoryPath "$(pwd)/icons" -OutputDirectoryPath "$(pwd)/package-icons"

      - name: <Artifact> Packed Icons
        uses: actions/upload-artifact@v4
        with:
          name: Package-Icons
          path: package-icons
          if-no-files-found: error
