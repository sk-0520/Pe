# プラグインを作ってみたくて試行錯誤中

Pe.Bridge, Pe.Bridge.Test, Pe.PluginBase プロジェクトは将来的に独立したリポジトリに格納し、
Pe からはサブモジュールで参照する予定。

## 方針

プラグインはテーマとアドオンの二つに分かれる。

### テーマ

テーマは Pe の表示周りの面倒を見る。

ダイアログなどは原則 Windows の描画に合わせるのでテーマ機能を使用しない。
ランチャーツールバー・コマンド・ノートあたりがテーマの対象となるがあくまで常時表示されるような項目が対象であり、
一時的に表示される部分、あえて標準描画庭せている部分はこの限りではない。
(ノートの操作パネル・コマンドの一覧等)

テーマの基本実装は Pe.Plugins.DefaultTheme となる。
ただしこれは必要部分のみの実装対応でプラグインとしても特別扱いされている状態。


### アドオン

アドオンは Pe に対して機能拡張を行う。

Pe は性質上、他のソフトを起動していればいいがせっかく .NET Core のランタイムを同梱しているのだからそれを使っていい感じに小粒のツールを作りたい思い。

一応の構想として以下機能に対応したい

1. ランチャーアイテム
1. コマンド
1. ウィジェット
1. バックグランド処理

#### ランチャーアイテム

ボタンに登録したり、ボタン押下時になんかするやつ。

#### コマンド

コマンド入力時に表示されるやつ。
ランチャーアイテムも登録していればコマンド一覧に表示するが本機能ではそのコマンド自体を生成する

#### ウィジェット

時計とかカレンダーとかね！
プラグインが保持できるウィンドウは 1 つのみに限定したい。

あと Pr.Bridge だけを参照していると CEF が見えないので以下のパターンには対応したい。

* プラグイン側で Window の生成
* Pe 側で WebView 回りの準備をしてプラグインに渡す(プラグインは HTML とあそぶだけ)


#### バックグランド処理

なんも考えてないけど、なんか悪いこと出来るよね。


## 考え中

* `interface` じゃなくて `abstract class` でもいいんじゃなかろうかと思ってる
   * 特にデータ受け渡し用のものまで `interface` だとしんどくない？
      * Pe.PluginBase でこのあたり吸収しようと思ってたけど、Pe.Bridge だけで組む場合に同じような実装がいくつもいくつも作られるのはなんかこう、ねぇ
         * 基本的な部分は `class` でいいでしょもう。めんどい
* プラグイン側で作られたスレッドの扱いとかどうしよう
* テーマ系が特にそうだけど、UIスレッドで呼ばれる・呼ばれないを明示的にしたい
* プラグインの設定データはある程度 Pe 側で何とかしようと思うけど、  
  どうにもならんようなデータに対してプラグイン専用のDBを用意するのもありかもねー

#### 初期化処理

1. プラグインディレクトリからプラグインDLL列挙（親ディレクトリ名から拡張子を外したものがDLLとする）
2. 破棄可能環境でDLLのロード
3. プラグイン情報から列挙DLLを突合
  * 存在する
    * 状態 -> *読み込み停止中*: **非読み込み対象**
    * 状態 -> *読み込み許可中*
      * バージョン検証
        * OK
          * プラグインIDをもとに名前・バージョン更新（異なれば）
          * **読み込み対象**
        * NG
          * プラグインIDをもとに名前・バージョン更新（異なれば）
          * 状態を*バージョン不一致*に変更
          * **非読み込み対象**
    * 状態 -> *バージョン不一致*
      * バージョン検証
        * OK
          * プラグインIDをもとに名前・バージョン更新（異なれば）
          * **読み込み対象**
        * NG
          * 状態を*バージョン不一致*に変更
          * プラグインIDをもとに名前・バージョン更新（異なれば）
          * **非読み込み対象**
  * 存在しない
      * バージョン検証
        * OK
          * 状態を*読み込み許可中*に変更
          * プラグインIDをもとに名前・バージョン追加
          * **読み込み対象**
        * NG
          * 状態を*バージョン不一致*に変更
          * プラグインIDをもとに名前・バージョン追加
          * **非読み込み対象**
4. **非読み込み対象** の DLL を解放
5. **読み込み対象** のプラグインIDをもとにプラグイン最終読み込み日時・回数を列挙
6. テーマを読み込み
7. アドオンを読み込み
8. 以上！



-----------------------



* current: [![Build status](https://ci.appveyor.com/api/projects/status/ycdw3l9d4g3jaif8?svg=true)](https://ci.appveyor.com/project/sk_0520/pe-bridge)
* master: [![Build status](https://ci.appveyor.com/api/projects/status/ycdw3l9d4g3jaif8/branch/master?svg=true)](https://ci.appveyor.com/project/sk_0520/pe-bridge/branch/master)


